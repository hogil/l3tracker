# Wafer Map Viewer - 변경사항 및 개선 기록

## 📋 개발 과정 요약

이 프로젝트는 **기존 웨이퍼 맵 뷰어의 사용성 개선**을 목표로 다양한 기능을 추가하고 최적화한 결과물입니다.

---

## 🚀 주요 개선사항 (총 8개 영역)

### **1. 폴더 선택 로직 개선**
#### 📋 **요구사항**
- Ctrl+클릭 시 폴더가 자동으로 열리지 않게 수정
- 폴더 선택만 하고 내용은 보이지 않게 유지

#### ✅ **구현 내용**
- `handleFileClick()` 메서드 수정
- Ctrl+클릭 시 `detailsElement.open = true` 로직 제거
- 폴더 선택 상태만 관리하도록 변경

#### 📁 **수정 파일**
- `main.js` (1099-1103번째 줄)

---

### **2. Shift 범위 선택 기능 추가**
#### 📋 **요구사항**
- Ctrl로 첫 번째 폴더 선택 후 Shift로 두 번째 폴더 선택 시
- 두 폴더 사이의 모든 폴더와 그 내부 파일들 선택

#### ✅ **구현 내용**
- `selectFolderRange()` 메서드 신규 구현
- `lastSelectedFolder` 상태 추가로 첫 번째 선택 기억
- DOM 순서 기반 범위 계산 및 일괄 선택

#### 📁 **수정 파일**
- `main.js` (879-912번째 줄, 1115-1129번째 줄)

---

### **3. 클래스 관리 시스템 안정화**
#### 📋 **요구사항**
- 우측 클래스 추가 버튼이 제대로 작동하지 않는 문제 해결
- classification 폴더에 클래스가 정상 생성되도록 수정

#### ✅ **구현 내용**
- `addClass()` 메서드에 에러 처리 및 사용자 피드백 추가
- 버튼 상태 관리 (로딩 중 표시, 비활성화)
- API 응답 확인 및 UI 갱신 보장

#### 📁 **수정 파일**
- `main.js` (1756-1796번째 줄)

---

### **4. 통합 검색 시스템 구현**
#### 📋 **요구사항**
- 상단에 폴더명/파일명 검색 입력창과 버튼 추가
- 매칭되는 모든 파일을 그리드 모드로 표시
- 포함 검색 방식 (부분 문자열 매칭)

#### ✅ **구현 내용**
- HTML에 검색 UI 추가 (폴더명/파일명 입력창 + 검색 버튼)
- `performSearch()` 및 `searchInDirectory()` 메서드 구현
- 재귀적 디렉터리 탐색으로 전체 파일 시스템 검색
- 검색 결과 자동 그리드 모드 전환

#### 📁 **수정 파일**
- `index.html` (699-705번째 줄)
- `main.js` (267-270, 780-799, 938-1010번째 줄)

---

### **5. 기본 그리드 모드 + 우클릭 컨텍스트 메뉴**
#### 📋 **요구사항**
- 단일 파일 선택 시에도 그리드 모드로 표시
- 그리드에서 우클릭 시 다양한 옵션 제공:
  - 파일 다운로드
  - 이미지 합치기 (N개 → √N×√N 그리드)
  - 파일 리스트 복사

#### ✅ **구현 내용**
- 파일 선택 로직 변경: `length >= 1` 조건으로 수정
- 컨텍스트 메뉴 HTML/CSS 추가
- `showContextMenu()`, `mergeAndCopyImages()`, `copyFileList()` 구현
- Canvas API를 이용한 이미지 합치기 기능
- 클립보드 API 연동 (이미지/텍스트)

#### 📁 **수정 파일**
- `index.html` (774-789, 675-688번째 줄)
- `main.js` (1287-1289, 1094-1283번째 줄)

---

### **6. 썸네일 품질 대폭 개선**
#### 📋 **요구사항**
- 썸네일 이미지 잘림 현상 수정
- 크기를 512px로 확대, 품질을 최대로 설정

#### ✅ **구현 내용**
- 썸네일 생성 로직 완전 재구현:
  - `thumbnail()` → `resize()` + 패딩 방식으로 변경
  - 비율 유지하며 검은 배경에 중앙 정렬
  - 크기: 128px → 512px (4배)
  - 품질: 70% → 95% (최대 품질)
- 백그라운드/포그라운드 썸네일 생성 모두 동일 로직 적용

#### 📁 **수정 파일**
- `api/config.py` (8-10번째 줄)
- `api/main.py` (167-189, 267-286번째 줄)

---

### **7. 백그라운드 작업 우선순위 최적화**
#### 📋 **요구사항**
- 백그라운드 썸네일 생성이 사용자 액션을 방해하지 않도록 개선

#### ✅ **구현 내용**
- 백그라운드 배치 크기: 50개 → 10개로 축소
- CPU 양보 주기: 0.5초 → 0.1초로 단축
- 사용자 액션 우선순위 보장

#### 📁 **수정 파일**
- `api/config.py` (18번째 줄)
- `api/main.py` (136-137번째 줄)

---

### **8. 사용자 경험 개선**
#### 📋 **요구사항**
- 버튼 클릭 시 즉시 피드백 제공 (응답성 개선)
- 검색 입력창 크기 확대

#### ✅ **구현 내용**
- 검색/클래스 추가 버튼에 로딩 상태 표시
- 작업 중 버튼 비활성화 및 텍스트 변경
- 검색 입력창 크기: 80px → 120px (1.5배)

#### 📁 **수정 파일**
- `index.html` (702-703번째 줄)
- `main.js` (948-970, 1760-1795번째 줄)

---

## 📊 성능 개선 결과

### **썸네일 품질**
- **이전**: 128px, 70% 품질, 잘림 현상
- **이후**: 512px, 95% 품질, 전체 이미지 표시

### **사용자 응답성**
- **이전**: 버튼 클릭 후 무반응 구간
- **이후**: 즉시 피드백 + 진행 상태 표시

### **검색 성능**
- **이전**: 검색 기능 없음
- **이후**: 전체 파일 시스템 재귀 검색

### **다중 선택 기능**
- **이전**: 개별 파일만 처리 가능
- **이후**: 범위 선택 + 일괄 처리 (다운로드/합치기/복사)

---

## 🛠️ 기술적 개선사항

### **코드 구조**
- **모듈화**: 기능별 메서드 분리
- **에러 처리**: try-catch 블록 추가
- **상태 관리**: 일관된 상태 업데이트 로직

### **API 최적화**
- **비동기 처리**: async/await 패턴 활용
- **백그라운드 작업**: 사용자 경험 방해 없는 처리
- **캐싱 전략**: 썸네일 및 파일 시스템 캐시

### **UI/UX 개선**
- **반응형 디자인**: 다양한 화면 크기 지원
- **키보드 단축키**: Ctrl, Shift 조합 지원
- **컨텍스트 메뉴**: 직관적인 우클릭 인터페이스

---

## 📈 사용성 개선 효과

### **이전 버전의 한계**
1. ❌ 단일 파일만 처리 가능
2. ❌ 폴더 선택 시 원치 않는 자동 열림
3. ❌ 검색 기능 부재
4. ❌ 썸네일 품질 저하 및 잘림
5. ❌ 버튼 응답성 부족

### **개선된 버전의 장점**
1. ✅ **다중 선택 및 일괄 처리** 지원
2. ✅ **직관적인 폴더 선택** (Ctrl/Shift 조합)
3. ✅ **강력한 통합 검색** (폴더+파일명)
4. ✅ **고품질 썸네일** (512px, 95% 품질)
5. ✅ **즉시 피드백** 및 진행 상태 표시
6. ✅ **컨텍스트 메뉴** (우클릭 다중 기능)
7. ✅ **이미지 합치기** 및 클립보드 연동

---

## 🎯 핵심 성과

### **생산성 향상**
- **검색 시간 단축**: 수동 탐색 → 즉시 검색
- **일괄 처리**: 개별 작업 → 다중 선택 처리
- **워크플로우 개선**: 다운로드/복사/합치기 원클릭

### **사용자 경험 개선**
- **직관적 인터페이스**: 컨텍스트 메뉴, 키보드 단축키
- **즉시 피드백**: 버튼 상태, 진행 표시
- **고품질 미리보기**: 선명한 썸네일

### **시스템 안정성**
- **에러 처리**: 견고한 예외 처리
- **성능 최적화**: 백그라운드 작업, 캐싱
- **확장성**: 모듈화된 코드 구조

이러한 개선을 통해 **단순한 이미지 뷰어**에서 **전문적인 웨이퍼 맵 분석 도구**로 발전시켰습니다.

---

## 🆕 최신 업데이트 (추가 개선사항)

### **9. 고급 검색 시스템 구현**
#### 📋 **요구사항**
- OR/AND/NOT 연산자와 괄호를 지원하는 복합 검색 기능
- 직관적인 검색 문법으로 정교한 파일 필터링

#### ✅ **구현 내용**
- **복합 연산자 지원**: `(center or donut) and not ring`
- **연산자 우선순위**: `()` > `NOT` > `AND` > `OR`
- **표현식 파서**: 재귀적 괄호 처리 및 토큰 기반 평가
- **오류 처리**: 구문 오류 시 기본 검색으로 폴백

#### 📁 **수정 파일**
- `main.js` (991-1107번째 줄): 고급 검색 로직
- `index.html` (717번째 줄): 검색창 확장 및 예시 업데이트

#### 🔍 **검색 예시**
```javascript
// 지원하는 검색 패턴들:
"center or donut"                    // OR 검색
"edge and ring"                      // AND 검색  
"not adaptive"                       // NOT 검색
"(center or donut) and padded"       // 괄호 우선순위
"center and (1 or 2) and not 3"     // 복합 조건
```

### **10. 컨텍스트 메뉴 확장**
#### 📋 **요구사항**
- 그리드 모드에서 우클릭 시 다양한 작업 옵션 제공
- 파일 리스트를 Excel 분석용 테이블 형태로 복사

#### ✅ **구현 내용**
- **파일리스트테이블복사**: TSV 형식으로 Excel 호환 테이블 생성
- **폴더+파일명 분할**: 언더스코어 기준으로 컬럼 분리
- **확장자 제거**: 깔끔한 데이터만 추출
- **ROOT 표시**: 최상위 파일들을 명확히 구분

#### 📁 **수정 파일**
- `index.html` (798-800번째 줄): 새 메뉴 항목 추가
- `main.js` (1365-1428, 1244-1248번째 줄): 테이블 복사 기능

#### 📊 **테이블 구조**
```
Folder      Name_Part1    Name_Part2    Name_Part3
'Center'    107           origin        
ROOT        Edge          Ring          adaptive
'Donut'     Center        1             padded
```

### **11. 폴더 숨기기 기능 확장**
#### 📋 **요구사항**
- 시스템 폴더들을 파일 탐색기에서 숨겨 UI 정리
- classification과 thumbnails 폴더 숨김 처리

#### ✅ **구현 내용**
- **다중 폴더 숨김**: `['classification', 'thumbnails']`
- **확장 가능한 구조**: 새로운 폴더 추가 용이

#### 📁 **수정 파일**
- `api/main.py` (495-497번째 줄): 폴더 필터링 로직

### **12. 파일 선택 동작 개선**
#### 📋 **요구사항**
- Ctrl/Shift 폴더 선택 시 자동 열림 방지
- 단일 이미지 클릭 시 자세히보기 모드로 직접 전환

#### ✅ **구현 내용**
- **이벤트 버블링 방지**: `e.stopPropagation()` 추가
- **선택 모드 분리**: 단일=자세히보기, 다중=그리드 모드
- **직관적 UX**: 사용자 의도에 맞는 뷰 모드 자동 선택

#### 📁 **수정 파일**
- `main.js` (1466-1510, 1537-1550번째 줄): 파일 선택 로직

### **13. UI 프레임 크기 최적화**
#### 📋 **요구사항**
- 좌측 탐색기와 우측 패널의 적절한 크기 조정
- 중앙 뷰어 영역 최적화

#### ✅ **구현 내용**
- **좌측 프레임**: 440px → 400px (적정 크기)
- **우측 프레임**: 390px 유지 (1.5배 확장)
- **반응형 지원**: min/max 너비로 유연성 확보

#### 📁 **수정 파일**
- `index.html` (47-50, 434-437번째 줄): CSS 프레임 크기

---

## 🛠️ 기술적 구현 세부사항

### **검색 시스템 아키텍처**
```javascript
// 검색 처리 흐름
fastFileNameSearch() 
  → matchesSearchQuery()
    → evaluateExpression()      // 괄호 처리
      → evaluateAndExpression() // AND 처리  
        → evaluateNotExpression() // NOT 처리
          → evaluateBasicTerm()  // 기본 매칭
```

### **컨텍스트 메뉴 이벤트 흐름**
```javascript
// 우클릭 → 메뉴 표시 → 항목 선택 → 기능 실행
showContextMenu() → initializeContextMenu() → copyFileListAsTable()
```

### **파일명 분할 알고리즘**
```javascript
// "origin/'Center'/107_origin.png" → 테이블 행 변환
1. 경로 분할: pathParts = filePath.split('/')
2. 폴더 추출: folder = pathParts[length-2] || 'ROOT'  
3. 파일명 추출: fileName = pathParts[length-1]
4. 확장자 제거: nameWithoutExt = fileName.replace(/\.[^/.]+$/, '')
5. 언더스코어 분할: nameParts = nameWithoutExt.split('_')
6. 테이블 구조 생성: {folder, part1, part2, part3, part4, part5}
```

### **성능 최적화 전략**
- **DOM 기반 검색**: API 호출 없이 클라이언트 사이드 처리
- **표현식 캐싱**: 복잡한 검색식의 중간 결과 토큰화
- **백그라운드 작업**: 썸네일 생성을 사용자 작업과 분리
- **이벤트 디바운싱**: 검색 입력 최적화

### **확장성 고려사항**
- **모듈화된 검색**: 새로운 연산자 추가 용이
- **플러그인 구조**: 컨텍스트 메뉴 항목 동적 추가 가능  
- **설정 외부화**: `config.py`를 통한 시스템 설정 관리
- **API 확장**: RESTful 구조로 새로운 엔드포인트 추가 용이

---

## 📋 개발자 가이드

### **새로운 기능 추가 시 체크리스트**
1. **기능 설계**: 사용자 요구사항 → 기술적 구현 방안
2. **파일 위치 결정**: 프론트엔드(`main.js`) vs 백엔드(`api/`)
3. **UI 업데이트**: `index.html`에 필요한 DOM 요소 추가
4. **이벤트 연결**: JavaScript에서 DOM 이벤트 리스너 등록
5. **API 연동**: 필요시 `api/main.py`에 엔드포인트 추가
6. **문서 업데이트**: `ARCHITECTURE.md`와 `CHANGELOG.md` 갱신

### **코드 수정 시 주의사항**
- **DOM 캐싱**: `cacheDom()` 메서드에 새 요소 추가
- **에러 처리**: try-catch 블록으로 견고성 확보
- **사용자 피드백**: 작업 중 상태 표시 및 완료 알림
- **브라우저 호환성**: 최신 API 사용 시 폴백 메커니즘 구현

### **성능 모니터링 포인트**
- **검색 속도**: `console.log`로 검색 시간 측정
- **썸네일 생성**: 백그라운드 작업 통계 API 활용
- **메모리 사용량**: 대량 이미지 처리 시 가상화 고려
- **네트워크 요청**: API 호출 최소화 및 캐싱 전략

이 상세한 기록을 통해 GitHub에서 프로젝트를 다운로드한 후 빠르게 코드를 이해하고 개선할 수 있습니다.

---

## 🐛 버그 수정 (2024년 최신)

### **14. Label Explorer 선택 유지 버그 수정**
#### 📋 **문제 상황**
- Wafer Map Explorer에서 여러 맵 선택 후 그리드 모드 진입
- Label Explorer의 빈 영역 클릭 시 Wafer Map Explorer 선택이 해제됨
- 선택 해제된 상태에서 라벨 추가 시 "Please select at least one image" 오류 발생

#### ✅ **해결 내용**
- **선택 유지**: Label Explorer 빈 영역 클릭 시 Wafer Map Explorer 선택 상태 유지
- **독립적 선택 관리**: Label Explorer와 Wafer Map Explorer의 선택 상태를 독립적으로 관리
- **사용자 경험 개선**: 의도치 않은 선택 해제로 인한 작업 중단 방지

#### 📁 **수정 파일**
- `main.js` (2722-2775번째 줄): Label Explorer 이벤트 핸들러 수정

#### 🔧 **기술적 변경사항**
```javascript
// 수정 전: Label Explorer 빈 영역 클릭 시
clearWaferMapExplorerSelection(); // Wafer Map Explorer 선택도 해제

// 수정 후: Label Explorer 빈 영역 클릭 시  
// clearWaferMapExplorerSelection() 호출 제거
// → Wafer Map Explorer 선택 유지, Label Explorer만 해제
```

#### 🎯 **수정된 이벤트 핸들러들**
1. **컨테이너 클릭**: `container.onclick` - Wafer Map Explorer 선택 유지
2. **컨테이너 우클릭**: `container.oncontextmenu` - Wafer Map Explorer 선택 유지  
3. **프레임 클릭**: `frame.onclick` - Wafer Map Explorer 선택 유지
4. **프레임 우클릭**: `frame.oncontextmenu` - Wafer Map Explorer 선택 유지

#### 📊 **동작 흐름 개선**
```
기존 흐름:
1. Wafer Map Explorer → 다중 선택 → 그리드 모드 ✅
2. Label Explorer 빈 영역 클릭 → 모든 선택 해제 ❌
3. 라벨 추가 시도 → "이미지를 선택해주세요" 오류 ❌

개선된 흐름:  
1. Wafer Map Explorer → 다중 선택 → 그리드 모드 ✅
2. Label Explorer 빈 영역 클릭 → Label Explorer만 해제, Wafer Map 선택 유지 ✅
3. 라벨 추가 → 정상 작동 ✅
```

#### 🎉 **사용자 경험 개선**
- **직관적 동작**: 각 패널의 선택이 독립적으로 관리됨
- **작업 연속성**: 의도치 않은 선택 해제로 인한 작업 중단 없음
- **일관성**: Windows 탐색기와 유사한 선택 동작 패턴 유지

이 수정을 통해 **라벨링 워크플로우가 크게 개선**되어 사용자가 더욱 효율적으로 작업할 수 있습니다.
